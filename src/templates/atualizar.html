<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atualizar Equipamentos</title>
  <style>
    :root {
      --dark: #1a1a2e;
      --darker: #0f3460;
      --accent: #e94560;
      --light: #ffffff;
      --gray: #2a2a3c;
      --success: #4caf50;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f5f5;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: var(--dark);
      color: var(--light);
      padding: 20px 0;
      position: fixed;
      height: 100%;
      overflow-y: auto;
    }

    .sidebar h2 {
      padding: 0 20px 20px;
      font-size: 1.4rem;
      color: var(--accent);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar li {
      padding: 10px 20px;
    }

    .sidebar a {
      color: var(--light);
      text-decoration: none;
      display: block;
      font-weight: 500;
    }

    .sidebar a:hover, .sidebar a.active {
      color: var(--accent);
    }

    .main-content {
      flex: 1;
      margin-left: 220px;
      padding: 20px;
    }

    header {
      background: var(--darker);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .search-box input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      min-width: 250px;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-sm { padding: 6px 10px; font-size: 0.9rem; }

    .btn:hover { opacity: 0.9; }

    #message {
      padding: 12px;
      margin: 20px 0;
      border-radius: 4px;
      display: none;
    }

    .msg-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .msg-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .accordion {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .accordion-header {
      background: #f8f9fa;
      padding: 14px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      border-bottom: 1px solid #eee;
    }

    .accordion-header:hover {
      background: #e9ecef;
    }

    .accordion-icon {
      transition: transform 0.2s;
    }

    .accordion.open .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-body {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease;
    }

    .accordion.open .accordion-body {
      padding: 20px;
      max-height: 1000px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #444;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .form-footer {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .notebook-highlight {
      border-left: 4px solid var(--accent);
    }

    .status-badge {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .sidebar { width: 60px; padding: 10px 0; }
      .sidebar h2, .sidebar a span { display: none; }
      .main-content { margin-left: 60px; }
      .search-box { flex-direction: column; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>‚öôÔ∏è Equipamentos</h2>
    <ul>
      <li><a href="/">üè† In√≠cio</a></li>
      <li><a href="/buscar">üîç Buscar</a></li>
      <li><a href="/listar">üìã Listar</a></li>
      <li><a href="/atualizar" class="active">‚úèÔ∏è Atualizar</a></li>
      <li><a href="/atualizar-teamviewer">üñ•Ô∏è TeamViewer</a></li>
    </ul>
  </aside>

  <div class="main-content">
    <header>
      <h2>‚úèÔ∏è Atualizar Equipamentos por Usu√°rio</h2>
      <a href="/" class="btn btn-secondary">‚Üê Voltar</a>
    </header>

    <div class="search-box">
      <input type="text" id="search-input" placeholder="Digite patrim√¥nio ou nome do usu√°rio..." />
      <button class="btn btn-primary" onclick="buscarEquipamentos()">Buscar</button>
    </div>

    <div id="message"></div>
    <div id="results-container" style="display:none;"></div>
  </div>

  <script>
    const API_URL = '/api/equipamentos';

    async function buscarEquipamentos() {
      const termo = document.getElementById('search-input').value.trim();
      if (!termo) {
        showMessage('Digite um patrim√¥nio ou nome de usu√°rio.', 'error');
        return;
      }

      try {
        let dados = [];
        const resPat = await fetch(`${API_URL}?patrimonio=${encodeURIComponent(termo)}`);
        const dataPat = await resPat.json();
        if (dataPat.length > 0) {
          dados = dataPat;
        } else {
          const resUser = await fetch(`${API_URL}?usuario=${encodeURIComponent(termo)}`);
          dados = await resUser.json();
        }

        if (dados.length === 0) {
          showMessage('Nenhum equipamento encontrado.', 'error');
          document.getElementById('results-container').style.display = 'none';
          return;
        }

        renderizarAcordeao(dados);
        document.getElementById('results-container').style.display = 'block';
        hideMessage();
      } catch (err) {
        showMessage('Erro ao buscar: ' + err.message, 'error');
      }
    }

    function renderizarAcordeao(equipamentos) {
      const container = document.getElementById('results-container');
      let html = `<h3 style="margin: 0 0 15px; color: var(--darker);">
        Encontrado(s) ${equipamentos.length} equipamento(s):
      </h3>`;

      equipamentos.forEach((item, index) => {
        const isNotebook = item.tipo === 'Notebook';
        const statusClass = item.status === 'Em uso' ? 'success' : 'warning';

        html += `
          <div class="accordion notebook-highlight" id="acc-${index}">
            <div class="accordion-header" onclick="toggleAccordion(${index})">
              <div>
                <strong>${item.patrimonio}</strong> ‚Äî ${item.tipo || '‚Äî'}
                ${item.usuario ? `<br><small>${item.usuario}</small>` : ''}
              </div>
              <div>
                <span class="status-badge">${item.status || '‚Äî'}</span>
                <span class="accordion-icon">‚ñº</span>
              </div>
            </div>
            <div class="accordion-body">
              <div class="form-grid">
                <div class="form-group">
                  <label>Patrim√¥nio</label>
                  <input type="text" id="pat_${index}" value="${item.patrimonio}" readonly />
                </div>
                <div class="form-group">
                  <label>Tipo</label>
                  <input type="text" value="${item.tipo || ''}" readonly />
                </div>
                <div class="form-group">
                  <label>Descritivo</label>
                  <input type="text" id="descritivo_${index}" value="${item.descritivo || ''}" placeholder="Ex: Dell Latitude 5420, i5, 16GB RAM" />
                </div>
                  <div class="form-group">
                  <label>N√∫mero de S√©rie</label>
                  <input type="text" id="numero_serie_${index}" value="${item.numero_serie || ''}" placeholder="Ex: 1234567890" />
                </div>
                <div class="form-group">
                  <label>Centro de Custo</label>
                  <input type="text" id="centro_custo_${index}" value="${item.centro_custo || ''}" placeholder="Ex: ENG-01, ADM-05" />
                </div>
                <div class="form-group">
                  <label>Usu√°rio</label>
                  <input type="text" id="usuario_${index}" value="${item.usuario || ''}" />
                </div>
                <div class="form-group">
                  <label>Cargo</label>
                  <input type="text" id="cargo_${index}" value="${item.cargo || ''}" />
                </div>
                <div class="form-group">
                  <label>Setor</label>
                  <input type="text" id="setor_${index}" value="${item.setor || ''}" />
                </div>
                <div class="form-group">
                  <label>Local</label>
                  <input type="text" id="local_${index}" value="${item.local_atual || ''}" />
                </div>
                <div class="form-group">
                  <label>Status</label>
                  <select id="status_${index}">
                    <option value="Em uso" ${item.status === 'Em uso' ? 'selected' : ''}>Em uso</option>
                    <option value="Devolvido" ${item.status === 'Devolvido' ? 'selected' : ''}>Devolvido</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>TeamViewer ID</label>
                  <input type="text" id="tv_${index}" value="${item.teamviewer_id || ''}" placeholder="123 456 789" />
                </div>
                ${isNotebook ? `
                <div class="form-group">
                  <label>Nome do Host (PC)</label>
                  <input type="text" id="host_${index}" value="${item.host || ''}" placeholder="ex: DESKTOP-ABC123" />
                </div>
                ` : ''}
                <div class="form-group">
                  <label>Data Devolu√ß√£o</label>
                  <input type="date" id="devolucao_${index}" value="${item.data_devolucao || ''}" />
                </div>
              </div>
              <div class="form-footer">
                <button class="btn btn-success" onclick="salvarEquipamento(${index}, '${item.patrimonio}')">
                  ‚úÖ Salvar Altera√ß√µes
                </button>
              </div>
              <div style="margin-top:10px; font-size:0.85rem; color:#666;">
                √öltima atualiza√ß√£o: ${item.data_recebimento || '‚Äî'}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function toggleAccordion(index) {
      const acc = document.getElementById(`acc-${index}`);
      acc.classList.toggle('open');
    }

    async function salvarEquipamento(index, patrimonio) {
      const dados = {
        numero_serie: document.getElementById(`numero_serie_${index}`).value || null,
        centro_custo: document.getElementById(`centro_custo_${index}`).value || null,
        usuario: document.getElementById(`usuario_${index}`).value || null,
        descritivo: document.getElementById(`descritivo_${index}`).value || null,
        cargo: document.getElementById(`cargo_${index}`).value || null,
        setor: document.getElementById(`setor_${index}`).value || null,
        local_atual: document.getElementById(`local_${index}`).value || null,
        status: document.getElementById(`status_${index}`).value,
        teamviewer_id: document.getElementById(`tv_${index}`).value || null,
        host: document.getElementById(`host_${index}`) 
              ? document.getElementById(`host_${index}`).value || null 
              : null,
        data_devolucao: document.getElementById(`devolucao_${index}`).value || null
      };

      // Remove campos vazios
      Object.keys(dados).forEach(k => {
        if (dados[k] === null || dados[k] === '') delete dados[k];
      });

      try {
        const res = await fetch(`${API_URL}/${patrimonio}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });

        if (res.ok) {
          showMessage(`‚úÖ ${patrimonio} atualizado com sucesso!`, 'success');
          setTimeout(hideMessage, 2000);
        } else {
          const erro = await res.json();
          showMessage(`‚ùå Erro ao salvar ${patrimonio}: ${erro.erro || 'falha desconhecida'}`, 'error');
        }
      } catch (err) {
        showMessage(`Erro de conex√£o ao salvar ${patrimonio}: ${err.message}`, 'error');
      }
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = type === 'success' ? 'msg-success' : 'msg-error';
      msg.style.display = 'block';
    }

    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }

    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') buscarEquipamentos();
    });
  </script>
</body>
</html>