{% extends "base.html" %}

{% block title %}Gerenciar Equipamentos{% endblock %}

{% block extra_css %}
<style>
  .table-equipamentos th {
    background: var(--darker);
    color: white;
    position: sticky;
    top: 0;
  }
  
  .status-em-uso { 
    color: #28a745; 
    font-weight: bold; 
  }
  
  .status-devolvido { 
    color: #dc3545; 
    font-weight: bold; 
  }
  
  /* Estilo dos bot√µes de a√ß√£o */
  .dt-buttons {
    margin-bottom: 10px;
  }
  
  .dataTables_wrapper .dataTables_filter input {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }
  
  /* Modal de detalhes */
  .modal-label {
    font-weight: 600;
    color: #495057;
  }
</style>

<!-- Bibliotecas para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-table me-2"></i>Gerenciar Equipamentos</h4>
  <div>
 <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#modalCadastro">
  <i class="bi bi-plus-circle me-1"></i> Novo Ativo
</button>
    <a href="/" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i> Voltar
    </a>
  </div>
</header>

<!-- Contador -->
<div class="alert alert-info mb-3 py-2 px-3">
  <span id="contador">Carregando...</span>
</div>

<!-- Filtros manuais -->
<div class="card mb-3">
  <div class="card-body p-3">
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label visually-hidden">Tipo</label>
        <select id="tipo-filtro" class="form-select form-select-sm">
          <option value="">Todos os tipos</option>
          <option value="Notebook">Notebook</option>
          <option value="Monitor">Monitor</option>
          <option value="Desktop">Desktop</option>
          <option value="Plotter/Impressora">Impressora/Plotter</option>
          <option value="Tablet">Tablet</option>
          <option value="Outro">Outro</option>
        </select>
      </div>
      
      <div class="col-md-3">
        <label class="form-label visually-hidden">Status</label>
        <select id="status-filtro" class="form-select form-select-sm">
          <option value="">Todos os status</option>
          <option value="Em uso">Em uso</option>
          <option value="Devolvido">Devolvido</option>
        </select>
      </div>
      
      <div class="col-md-4">
        <label class="form-label visually-hidden">Buscar por Patrim√¥nio(s)</label>
        <input type="text" id="patrimonio-filtro" class="form-control form-control-sm" placeholder="Patrim√¥nio(s): PAT001, PAT002">
        <div class="form-text small">Separe por v√≠rgula ou espa√ßo</div>
      </div>
      
      <div class="col-md-2 d-flex align-items-end">
        <button onclick="carregarEquipamentos()" class="btn btn-primary btn-sm w-100">
          <i class="bi bi-search me-1"></i> Filtrar
        </button>
      </div>
    </div>
    
    <!-- Bot√µes de a√ß√£o em lote -->
    <div class="mt-2 d-flex flex-wrap gap-2">
      <button class="btn btn-warning btn-sm" onclick="toggleSelecao()">
        <i class="bi bi-check-all me-1"></i> Selecionar todos
      </button>
      <button class="btn btn-success btn-sm" onclick="exportarCSV()">
        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Exportar CSV
      </button>
      <button class="btn btn-danger btn-sm" onclick="exportarPDF()">
        <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
      </button>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="loading" class="text-center py-4" style="display:none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Carregando...</span>
  </div>
</div>

<!-- Tabela -->
<div id="table-container" style="display:none;">
  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-outline-danger btn-sm" onclick="atualizarLote('Devolvido')">
      <i class="bi bi-arrow-return-left me-1"></i> Devolver Selecionados
    </button>
    <button class="btn btn-outline-success btn-sm" onclick="atualizarLote('Em uso')">
      <i class="bi bi-check-circle me-1"></i> Receber Selecionados
    </button>
    <button class="btn btn-outline-dark btn-sm" onclick="excluirLote()">
      <i class="bi bi-trash me-1"></i> Excluir Selecionados
    </button>
  </div>
  
  <div class="table-responsive">
    <table id="tabela-equipamentos" class="table table-hover table-equipamentos align-middle" style="width:100%">
      <thead>
        <tr>
          <th><input type="checkbox" id="selecionar-todos" onchange="toggleTodos()"></th>
          <th>Patrim√¥nio</th>
          <th>N¬∫ S√©rie</th>
          <th>Tipo</th>
          <th>Usu√°rio</th>
          <th>Local</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="corpo-tabela">
        <!-- Ser√° preenchido pelo JS -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetalhesLabel">Detalhes do Equipamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="form-detalhes">
          <input type="hidden" id="modal-patrimonio">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label modal-label">Patrim√¥nio</label>
              <input type="text" class="form-control" id="modal-patrimonio-ro" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label modal-label">Tipo</label>
              <input type="text" class="form-control" id="modal-tipo" readonly>
            </div>
            
            <div class="col-12">
              <label class="form-label modal-label">Descritivo</label>
              <input type="text" class="form-control" id="modal-descritivo" placeholder="Ex: Dell Latitude 5420, i5, 16GB RAM">
            </div>
            
            <div class="col-md-6">
              <label class="form-label modal-label">N√∫mero de S√©rie</label>
              <input type="text" class="form-control" id="modal-numero_serie" placeholder="Ex: SN123456789">
            </div>
            <div class="col-md-6">
              <label class="form-label modal-label">Centro de Custo</label>
              <input type="text" class="form-control" id="modal-centro_custo" placeholder="Ex: ENG-01">
            </div>
            
            <div class="col-md-6">
              <label class="form-label modal-label">Usu√°rio</label>
              <input type="text" class="form-control" id="modal-usuario" placeholder="Nome do usu√°rio">
            </div>
            <div class="col-md-6">
              <label class="form-label modal-label">Cargo</label>
              <input type="text" class="form-control" id="modal-cargo" placeholder="Ex: T√©cnico">
            </div>
            
            <div class="col-md-6">
              <label class="form-label modal-label">Setor</label>
              <input type="text" class="form-control" id="modal-setor" placeholder="Ex: Engenharia">
            </div>
            <div class="col-md-6">
              <label class="form-label modal-label">Local</label>
              <input type="text" class="form-control" id="modal-local_atual" placeholder="Ex: Canteiro A">
            </div>
            
            <div class="col-md-6">
              <label class="form-label modal-label">Status</label>
              <select class="form-select" id="modal-status">
                <option value="Em uso">Em uso</option>
                <option value="Devolvido">Devolvido</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label modal-label">TeamViewer ID</label>
              <input type="text" class="form-control" id="modal-teamviewer_id" placeholder="123 456 789">
            </div>
            
            <div class="col-12" id="campo-host" style="display:none;">
              <label class="form-label modal-label">Nome do Host (PC)</label>
              <input type="text" class="form-control" id="modal-host" placeholder="ex: DESKTOP-ABC123">
            </div>
            
            <div class="col-md-6">
              <label class="form-label modal-label">Data de Recebimento</label>
              <input type="date" class="form-control" id="modal-data_recebimento">
            </div>
            <div class="col-md-6">
              <label class="form-label modal-label">Data de Devolu√ß√£o</label>
              <input type="date" class="form-control" id="modal-data_devolucao">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="btn-excluir-modal">üóëÔ∏è Excluir</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" id="btn-salvar-modal">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const API_URL = '/api/equipamentos';
  let dadosOriginais = [];
  let tabela = null;
  let todosSelecionados = false;

  async function carregarEquipamentos() {
    const tipo = document.getElementById('tipo-filtro').value;
    const status = document.getElementById('status-filtro').value;
    const patInput = document.getElementById('patrimonio-filtro').value.trim();

    let patrimonios = [];
    if (patInput) {
      patrimonios = patInput
        .split(/[,;\s]+/)
        .map(p => p.trim())
        .filter(p => p);
    }

    try {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('table-container').style.display = 'none';

      if (patrimonios.length > 0) {
        const promessas = patrimonios.map(p => 
          fetch(`${API_URL}?patrimonio=${encodeURIComponent(p)}`).then(r => r.json())
        );
        const resultados = await Promise.all(promessas);
        let dados = resultados.flat();

        if (tipo) dados = dados.filter(item => item.tipo === tipo);
        if (status) dados = dados.filter(item => item.status === status);

        dadosOriginais = dados;
      } else {
        const params = new URLSearchParams();
        if (tipo) params.append('tipo', tipo);
        if (status) params.append('status', status);
        
        const url = `${API_URL}?${params.toString()}`;
        const res = await fetch(url);
        dadosOriginais = await res.json();
      }

      // Destroi a tabela anterior se existir
      if (tabela) {
        tabela.destroy();
      }

      // Preenche o tbody
      const tbody = document.querySelector('#tabela-equipamentos tbody');
      tbody.innerHTML = '';
      
      dadosOriginais.forEach(item => {
        const statusClass = 
          item.status === 'Em uso' ? 'status-em-uso' : 
          item.status === 'Devolvido' ? 'status-devolvido' : '';

        const acoes = `
          <button class="btn btn-sm btn-outline-primary me-1" onclick="abrirModal('${item.patrimonio}')">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger me-1" onclick="atualizarStatus('${item.patrimonio}', 'Devolvido')">
            <i class="bi bi-arrow-return-left"></i>
          </button>
          <button class="btn btn-sm btn-outline-warning" onclick="deletarEquipamento('${item.patrimonio}')">
            <i class="bi bi-trash"></i>
          </button>
        `;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="checkbox-item" data-pat="${item.patrimonio}"></td>
          <td>${item.patrimonio || ''}</td>
          <td>${item.numero_serie || ''}</td>
          <td>${item.tipo || ''}</td>
          <td>${item.usuario || ''}</td>
          <td>${item.local_atual || ''}</td>
          <td><span class="${statusClass}">${item.status || ''}</span></td>
          <td>${acoes}</td>
        `;
        tbody.appendChild(tr);
      });

      // Inicializa o DataTables
      tabela = new DataTable('#tabela-equipamentos', {
        responsive: true,
        paging: true,
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],
        searching: true,
        ordering: true,
        info: true,
        language: {
          url: "https://cdn.datatables.net/plug-ins/2.3.6/i18n/pt-BR.json"
        }
      });

      atualizarContador(dadosOriginais.length);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('table-container').style.display = 'block';

    } catch (err) {
      alert('Erro ao carregar: ' + err.message);
      document.getElementById('loading').style.display = 'none';
    }
  }

  // Fun√ß√£o para abrir o modal de detalhes
  async function abrirModal(patrimonio) {
    try {
      const res = await fetch(`${API_URL}?patrimonio=${encodeURIComponent(patrimonio)}`);
      const dados = await res.json();
      
      if (dados.length === 0) {
        alert('Equipamento n√£o encontrado.');
        return;
      }
      
      const item = dados[0];
      
      // Preenche os campos
      document.getElementById('modal-patrimonio').value = patrimonio;
      document.getElementById('modal-patrimonio-ro').value = patrimonio;
      document.getElementById('modal-tipo').value = item.tipo || '';
      document.getElementById('modal-descritivo').value = item.descritivo || '';
      document.getElementById('modal-numero_serie').value = item.numero_serie || '';
      document.getElementById('modal-centro_custo').value = item.centro_custo || '';
      document.getElementById('modal-usuario').value = item.usuario || '';
      document.getElementById('modal-cargo').value = item.cargo || '';
      document.getElementById('modal-setor').value = item.setor || '';
      document.getElementById('modal-local_atual').value = item.local_atual || '';
      document.getElementById('modal-status').value = item.status || 'Em uso';
      document.getElementById('modal-teamviewer_id').value = item.teamviewer_id || '';
      document.getElementById('modal-host').value = item.host || '';
      document.getElementById('modal-data_recebimento').value = item.data_recebimento || '';
      document.getElementById('modal-data_devolucao').value = item.data_devolucao || '';
      
      // Mostra campo host s√≥ para notebooks
      const campoHost = document.getElementById('campo-host');
      campoHost.style.display = (item.tipo === 'Notebook') ? 'block' : 'none';
      
      // Abre o modal
      const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
      modal.show();
      
    } catch (err) {
      alert('Erro ao carregar detalhes: ' + err.message);
    }
  }

  // Salvar altera√ß√µes no modal
  async function salvarAlteracoesModal() {
    const patrimonio = document.getElementById('modal-patrimonio').value;
    
    const dados = {
      descritivo: document.getElementById('modal-descritivo').value || null,
      numero_serie: document.getElementById('modal-numero_serie').value || null,
      centro_custo: document.getElementById('modal-centro_custo').value || null,
      usuario: document.getElementById('modal-usuario').value || null,
      cargo: document.getElementById('modal-cargo').value || null,
      setor: document.getElementById('modal-setor').value || null,
      local_atual: document.getElementById('modal-local_atual').value || null,
      status: document.getElementById('modal-status').value,
      teamviewer_id: document.getElementById('modal-teamviewer_id').value || null,
      host: document.getElementById('campo-host').style.display === 'none' ? null : (document.getElementById('modal-host').value || null),
      data_recebimento: document.getElementById('modal-data_recebimento').value || null,
      data_devolucao: document.getElementById('modal-data_devolucao').value || null
    };

    // Remove campos vazios
    Object.keys(dados).forEach(k => {
      if (dados[k] === null || dados[k] === '') delete dados[k];
    });

    try {
      const res = await fetch(`${API_URL}/${patrimonio}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });

      if (res.ok) {
        alert('‚úÖ Altera√ß√µes salvas com sucesso!');
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
        modal.hide();
        carregarEquipamentos();
      } else {
        const erro = await res.json();
        alert('‚ùå Erro: ' + (erro.erro || 'Falha ao salvar'));
      }
    } catch (err) {
      alert('Erro de conex√£o: ' + err.message);
    }
  }

  // Excluir via modal
  async function excluirDoModal() {
    const patrimonio = document.getElementById('modal-patrimonio').value;
    await deletarEquipamento(patrimonio, true);
  }

  // Fun√ß√£o de exclus√£o individual
  async function deletarEquipamento(patrimonio, doModal = false) {
    if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\nTem certeza que deseja EXCLUIR PERMANENTEMENTE o equipamento ${patrimonio}?\nEssa a√ß√£o n√£o pode ser desfeita.`)) {
      return;
    }

    try {
      const res = await fetch(`${API_URL}/${patrimonio}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });

      if (res.ok) {
        alert('‚úÖ Equipamento exclu√≠do com sucesso!');
        if (doModal) {
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
          modal.hide();
        }
        carregarEquipamentos();
      } else {
        const erro = await res.json();
        alert('‚ùå Erro: ' + (erro.erro || 'Falha ao excluir'));
      }
    } catch (err) {
      alert('Erro de conex√£o: ' + err.message);
    }
  }

  // Fun√ß√£o de exclus√£o em lote
  async function excluirLote() {
    const selecionados = Array.from(document.querySelectorAll('.checkbox-item:checked'))
      .map(cb => cb.dataset.pat);

    if (selecionados.length === 0) {
      alert('‚ö†Ô∏è Nenhum equipamento selecionado para exclus√£o.');
      return;
    }

    const mensagem = `‚ö†Ô∏è ATEN√á√ÉO!\nTem certeza que deseja EXCLUIR PERMANENTEMENTE ${selecionados.length} equipamento(s)?\nEssa a√ß√£o n√£o pode ser desfeita.`;
    
    if (!confirm(mensagem)) {
      return;
    }

    let sucesso = 0;
    for (const pat of selecionados) {
      try {
        const res = await fetch(`${API_URL}/${pat}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        if (res.ok) sucesso++;
      } catch (e) {
        console.error('Falha ao excluir', pat, e);
      }
    }

    alert(`‚úÖ ${sucesso} de ${selecionados.length} equipamento(s) exclu√≠do(s) com sucesso!`);
    carregarEquipamentos();
  }

  // Event listeners para o modal
  document.getElementById('btn-salvar-modal').addEventListener('click', salvarAlteracoesModal);
  document.getElementById('btn-excluir-modal').addEventListener('click', excluirDoModal);

  // Fun√ß√µes de sele√ß√£o
  function atualizarContador(total) {
    document.getElementById('contador').textContent = 
      `Total de equipamentos encontrados: ${total}`;
  }

  function toggleTodos() {
    const checkboxes = document.querySelectorAll('.checkbox-item');
    const checked = document.getElementById('selecionar-todos').checked;
    checkboxes.forEach(cb => cb.checked = checked);
  }

  function toggleSelecao() {
    todosSelecionados = !todosSelecionados;
    const btn = document.querySelector('.btn-warning');
    btn.innerHTML = todosSelecionados 
      ? '<i class="bi bi-x-circle me-1"></i> Limpar sele√ß√£o' 
      : '<i class="bi bi-check-all me-1"></i> Selecionar todos';
    
    const checkboxes = document.querySelectorAll('.checkbox-item');
    checkboxes.forEach(cb => cb.checked = todosSelecionados);
    document.getElementById('selecionar-todos').checked = todosSelecionados;
  }

  // Fun√ß√µes de atualiza√ß√£o de status
  async function atualizarStatus(patrimonio, novoStatus) {
    if (!confirm(`Tem certeza que deseja marcar ${patrimonio} como "${novoStatus}"?`)) return;

    try {
      const res = await fetch(`${API_URL}/${patrimonio}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: novoStatus })
      });

      if (res.ok) {
        alert('‚úÖ Status atualizado com sucesso!');
        carregarEquipamentos();
      } else {
        const erro = await res.json();
        alert('‚ùå Erro: ' + (erro.erro || 'Falha ao salvar'));
      }
    } catch (err) {
      alert('Erro de conex√£o: ' + err.message);
    }
  }

  async function atualizarLote(novoStatus) {
    const selecionados = Array.from(document.querySelectorAll('.checkbox-item:checked'))
      .map(cb => cb.dataset.pat);

    if (selecionados.length === 0) {
      alert('‚ö†Ô∏è Nenhum equipamento selecionado.');
      return;
    }

    if (!confirm(`Atualizar ${selecionados.length} equipamento(s) para "${novoStatus}"?`)) return;

    let sucesso = 0;
    for (const pat of selecionados) {
      try {
        const res = await fetch(`${API_URL}/${pat}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: novoStatus })
        });
        if (res.ok) sucesso++;
      } catch (e) {
        console.error('Falha ao atualizar', pat, e);
      }
    }

    alert(`‚úÖ ${sucesso} de ${selecionados.length} atualizado(s) com sucesso!`);
    carregarEquipamentos();
  }

  // Exporta√ß√µes
  function exportarCSV() {
    if (dadosOriginais.length === 0) {
      alert('Nenhum dado para exportar.');
      return;
    }

    const colunas = ['Patrim√¥nio', 'N√∫mero de S√©rie', 'Tipo', 'Usu√°rio', 'Cargo', 'Setor', 'Local', 'Status', 'TeamViewer ID', 'Host'];
    let csv = colunas.join(',') + '\n';

    dadosOriginais.forEach(item => {
      const linha = [
        `"${(item.patrimonio || '').replace(/"/g, '""')}"`,
        `"${(item.numero_serie || '').replace(/"/g, '""')}"`,
        `"${(item.tipo || '').replace(/"/g, '""')}"`,
        `"${(item.usuario || '').replace(/"/g, '""')}"`,
        `"${(item.cargo || '').replace(/"/g, '""')}"`,
        `"${(item.setor || '').replace(/"/g, '""')}"`,
        `"${(item.local_atual || '').replace(/"/g, '""')}"`,
        `"${(item.status || '').replace(/"/g, '""')}"`,
        `"${(item.teamviewer_id || '').replace(/"/g, '""')}"`,
        `"${(item.host || '').replace(/"/g, '""')}"`
      ].join(',');
      csv += linha + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `equipamentos_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportarPDF() {
    if (dadosOriginais.length === 0) {
      alert('Nenhum dado para exportar.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text('Relat√≥rio de Equipamentos', 14, 20);
    const data = new Date().toLocaleDateString('pt-BR');
    doc.setFontSize(12);
    doc.text(`Data: ${data}`, 14, 28);

    const grupos = {};
    dadosOriginais.forEach(item => {
      const tipo = item.tipo || 'Sem tipo';
      if (!grupos[tipo]) grupos[tipo] = [];
      grupos[tipo].push(item);
    });

    const tiposOrdenados = Object.keys(grupos).sort();
    const colunas = ['Descritivo', 'Patrim√¥nio', 'N¬∫ S√©rie'];
    const corpo = [];

    tiposOrdenados.forEach(tipo => {
      const itens = grupos[tipo];
      corpo.push([
        { content: `${tipo} (${itens.length})`, colSpan: 3, styles: { fillColor: [230, 230, 230], fontStyle: 'bold' } }
      ]);
      itens.forEach(item => {
        corpo.push([
          item.descritivo || '',
          item.patrimonio || '',
          item.numero_serie || ''
        ]);
      });
    });

    doc.autoTable({
      startY: 35,
      head: [colunas],
      body: corpo,
      theme: 'grid',
      styles: { fontSize: 9 },
      headStyles: { fillColor: [13, 74, 130] },
      columnStyles: {
        0: { cellWidth: 85 },
        1: { cellWidth: 35 },
        2: { cellWidth: 40 }
      }
    });

    doc.save(`equipamentos_por_tipo_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // Inicializa√ß√£o
  window.onload = () => {
    carregarEquipamentos();
  };

  document.getElementById('patrimonio-filtro').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') carregarEquipamentos();
  });
</script>
{% endblock %}