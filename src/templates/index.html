{% extends "base.html" %}

{% block title %}Dashboard - Equipamentos{% endblock %}

{% block extra_css %}
<style>
  .card-stats {
    border-left: 4px solid var(--accent);
    transition: transform 0.2s;
  }
  
  .card-stats:hover {
    transform: translateY(-2px);
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
  }
  
  .trend-up {
    color: #28a745;
    font-weight: bold;
  }
  
  .trend-down {
    color: #dc3545;
    font-weight: bold;
  }
  
  .chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-top: 1rem;
  }
  
  .chart-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    margin: 5px 0;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3"><i class="bi bi-speedometer2 me-2"></i> Dashboard</h1>
  <div>
<button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#modalCadastro">
  <i class="bi bi-plus-circle me-1"></i> Novo Ativo
</button>
  </div>
</header>

<!-- Cards de Resumo -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card card-stats">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="mb-1 text-muted">Total de Ativos</p>
            <div class="stat-value" id="total-ativos">...</div>
          </div>
          <span class="text-success"><i class="bi bi-arrow-up me-1"></i>2.5%</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card card-stats">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="mb-1 text-muted">Em Uso</p>
            <div class="stat-value" id="em-uso">...</div>
          </div>
          <span class="text-success"><i class="bi bi-arrow-up me-1"></i>0.5%</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card card-stats">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="mb-1 text-muted">Devolvidos</p>
            <div class="stat-value" id="devolvidos">...</div>
          </div>
          <span class="text-danger"><i class="bi bi-arrow-down me-1"></i>0.2%</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card card-stats">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="mb-1 text-muted">Notebooks</p>
            <div class="stat-value" id="notebooks">...</div>
          </div>
          <span class="text-success"><i class="bi bi-arrow-up me-1"></i>0.12%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Gr치fico: Por Tipo -->
<h2 class="h5 mb-3">游빑 Equipamentos por Tipo</h2>
<div class="chart-container">
  <h6 class="chart-title">Distribui칞칚o por Categoria</h6>
  <canvas id="chart-tipo" height="100"></canvas>
</div>

<!-- Gr치fico: Status -->
<div class="row mt-4">
  <div class="col-lg-6">
    <div class="chart-container">
      <h6 class="chart-title">Status dos Ativos</h6>
      <canvas id="chart-status" height="100"></canvas>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <h6 class="chart-title">Locais Mais Utilizados</h6>
        <div id="por-local-lista">
          <!-- Ser치 preenchido via JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<div class="mt-5 text-center text-muted">
  <small>칔ltima atualiza칞칚o: <span id="last-update">Carregando...</span></small>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const API_URL = '/api/equipamentos';
  let chartTipo = null;
  let chartStatus = null;

  async function fetchAll() {
    const res = await fetch(API_URL);
    return await res.json();
  }

  function groupBy(array, key) {
    return array.reduce((acc, item) => {
      const valor = item[key] || 'N칚o informado';
      acc[valor] = (acc[valor] || 0) + 1;
      return acc;
    }, {});
  }

  async function loadDashboard() {
    try {
      const todos = await fetchAll();

      // === Atualiza os cards ===
      const totalAtivos = todos.length;
      const emUso = todos.filter(e => e.status === 'Em uso').length;
      const devolvidos = todos.filter(e => e.status === 'Devolvido').length;
      const notebooks = todos.filter(e => e.tipo === 'Notebook').length;

      document.getElementById('total-ativos').textContent = totalAtivos;
      document.getElementById('em-uso').textContent = emUso;
      document.getElementById('devolvidos').textContent = devolvidos;
      document.getElementById('notebooks').textContent = notebooks;

      // === Gr치fico: Por Tipo ===
      const porTipo = groupBy(todos, 'tipo');
      const labels = Object.keys(porTipo);
      const values = Object.values(porTipo);

      if (chartTipo) chartTipo.destroy();
      chartTipo = new Chart(document.getElementById('chart-tipo'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade',
            data: values,
            backgroundColor: [
              '#e94560', '#4caf50', '#ff9800', '#2196f3', '#9c27b0', '#009688'
            ],
            borderColor: [
              '#d03750', '#388e3c', '#f57f17', '#1976d2', '#7b1fa2', '#00796b'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });

      // === Gr치fico: Status ===
      if (chartStatus) chartStatus.destroy();
      chartStatus = new Chart(document.getElementById('chart-status'), {
        type: 'doughnut',
        data: {
          labels: ['Em Uso', 'Devolvidos'],
          datasets: [{
            data: [emUso, devolvidos],
            backgroundColor: ['#4caf50', '#ff9800'],
            borderColor: ['#388e3c', '#f57f17'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                usePointStyle: true
              }
            }
          }
        }
      });

      // === Locais Mais Utilizados ===
      const porLocal = groupBy(todos, 'local_atual');
      const locaisOrdenados = Object.entries(porLocal)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);

      const lista = document.getElementById('por-local-lista');
      lista.innerHTML = '';
      locaisOrdenados.forEach(([local, qtd]) => {
        const percent = ((qtd / totalAtivos) * 100).toFixed(1);
        lista.innerHTML += `
          <div class="legend-item">
            <div style="width: 12px; height: 12px; background: #2196f3; border-radius: 50%;"></div>
            <span>${local}</span>
            <span class="ms-auto">${percent}%</span>
          </div>
        `;
      });

      // Atualiza data
      document.getElementById('last-update').textContent = 
        new Date().toLocaleString('pt-BR');

      document.getElementById('loading').style.display = 'none';

    } catch (err) {
      console.error('Erro ao carregar dados:', err);
      document.getElementById('loading').innerHTML = 
        `<div class="alert alert-danger">Erro ao carregar dashboard</div>`;
    }
  }

  loadDashboard();

  window.addEventListener('resize', () => {
    if (chartTipo) chartTipo.resize();
    if (chartStatus) chartStatus.resize();
  });
</script>
{% endblock %}