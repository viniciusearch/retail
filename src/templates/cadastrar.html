{% extends "base.html" %}

{% block title %}Cadastrar Novo Equipamento{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h4 mb-0"><i class="bi bi-plus-circle me-2"></i>Cadastrar Novo Equipamento</h1>
  <a href="/home" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> Voltar
  </a>
</header>

<div class="card">
  <div class="card-body">
    <p class="text-muted mb-4">Preencha os dados do ativo. O patrimônio é obrigatório.</p>
    
    <form id="cadastro-form">
      <div class="row g-3">
        <!-- Campos obrigatórios -->
        <div class="col-md-6">
          <label class="form-label">Patrimônio <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="patrimonio" required placeholder="Ex: PAT12345">
        </div>
        
        <div class="col-md-6">
          <label class="form-label">Tipo <span class="text-danger">*</span></label>
          <select class="form-select" id="tipo" required>
            <option value="">Selecione</option>
            <option value="Notebook">Notebook</option>
            <option value="Desktop">Desktop</option>
            <option value="Monitor">Monitor</option>
            <option value="Impressora">Impressora</option>
            <option value="Plotter">Plotter</option>
            <option value="Tablet">Tablet</option>
            <option value="Outro">Outro</option>
          </select>
        </div>

        <!-- Descritivo -->
        <div class="col-12">
          <label class="form-label">Descritivo</label>
          <input type="text" class="form-control" id="descritivo" placeholder="Ex: Dell Latitude 5420, i5, 16GB RAM">
        </div>

        <!-- Campos opcionais -->
        <div class="col-md-6">
          <label class="form-label">Número de Série</label>
          <input type="text" class="form-control" id="numero_serie" placeholder="Ex: SN123456789">
        </div>
        
        <div class="col-md-6">
          <label class="form-label">Local Atual</label>
          <input type="text" class="form-control" id="local_atual" placeholder="Ex: Canteiro A">
        </div>
        
        <div class="col-md-6">
          <label class="form-label">Setor</label>
          <input type="text" class="form-control" id="setor" placeholder="Ex: Engenharia">
        </div>
        
        <div class="col-md-6">
          <label class="form-label">Status</label>
          <select class="form-select" id="status">
            <option value="Em uso">Em uso</option>
            <option value="Devolvido">Devolvido</option>
          </select>
        </div>
        
        <div class="col-md-6">
          <label class="form-label">TeamViewer ID</label>
          <input type="text" class="form-control" id="teamviewer_id" placeholder="123 456 789">
        </div>
        
        <div class="col-md-6" id="host-field" style="display:none;">
          <label class="form-label">Nome do Host (PC)</label>
          <input type="text" class="form-control" id="host" placeholder="ex: DESKTOP-ABC123">
        </div>
        
        <div class="col-12">
          <label class="form-label">Observações</label>
          <textarea class="form-control" id="observacao" rows="3" placeholder="Informações adicionais..."></textarea>
        </div>
      </div>
      
      <div class="mt-4 d-flex gap-2 flex-wrap">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-circle me-1"></i> Cadastrar Equipamento
        </button>
        <button type="reset" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-clockwise me-1"></i> Limpar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="message" class="alert alert-dismissible fade show mt-3" role="alert" style="display:none;">
  <span id="message-text"></span>
  <button type="button" class="btn-close" onclick="hideMessage()"></button>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Mostrar campo host só para notebook
  document.getElementById('tipo').addEventListener('change', function() {
    const hostField = document.getElementById('host-field');
    hostField.style.display = this.value === 'Notebook' ? 'block' : 'none';
  });

  document.getElementById('cadastro-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const dados = {
      patrimonio: document.getElementById('patrimonio').value.trim(),
      tipo: document.getElementById('tipo').value,
      descritivo: document.getElementById('descritivo').value || null,
      numero_serie: document.getElementById('numero_serie').value || null,
      local_atual: document.getElementById('local_atual').value || null,
      setor: document.getElementById('setor').value || null,
      status: document.getElementById('status').value,
      teamviewer_id: document.getElementById('teamviewer_id').value || null,
      host: document.getElementById('host').value || null,
      observacao: document.getElementById('observacao').value || null
    };

    if (!dados.patrimonio || !dados.tipo) {
      showMessage('Patrimônio e Tipo são obrigatórios.', 'danger');
      return;
    }

    try {
      const res = await fetch('/api/equipamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });

      const result = await res.json();
      if (res.ok) {
        showMessage(`✅ ${result.mensagem}! Patrimônio: ${result.patrimonio}`, 'success');
        document.getElementById('cadastro-form').reset();
        document.getElementById('host-field').style.display = 'none';
      } else {
        showMessage(`❌ ${result.erro || 'Erro ao cadastrar'}`, 'danger');
      }
    } catch (err) {
      showMessage('Falha na conexão: ' + err.message, 'danger');
    }
  });

  function showMessage(text, type) {
    const msg = document.getElementById('message');
    const msgText = document.getElementById('message-text');
    msgText.textContent = text;
    msg.className = `alert alert-${type} alert-dismissible fade show`;
    msg.style.display = 'block';
  }

  function hideMessage() {
    document.getElementById('message').style.display = 'none';
  }
</script>
{% endblock %}